# Machine Learning to Detect Malware
By: Tung Phung

<p align="center">
  <img width="320" height="260" src="./presentationimages/malware-cybersecurity-skull-crossbone-100735067-large.jpg">
</p>

## Goals:
Malware (viruses, worms, and trojans) detection is typically done by cybersecurity professionals in an analog, but still digital manner. By using a suite of tools available to most programmers, they meticulously pore over the Portable Executable's (PE) (e.g., a .exe or .dll) method of execution and its attack vectors. This can be done by analyzing the PE's header, strings, hex code, and even its decompiled binary. Following this, the security researcher comes up with a list of "fingerprints" or distinct markers of the virus, which could range from its attack vector to the overall structure of the binary. 

This leads to malware software which attempts to identify this malware through specific, generic, and heuristic detection methods. Each of these approaches has its strengths and weaknesses. Specific detection is finding the exact same piece of malware which has already been previously detected. It matches exactly, but small changes can often lead to false negatives. Generic detection detects similar classes of malware, oftentimes where something very small has been changed in an attempt to evade the specific filters. Finally, heuristic detection is where malware detection looks for specific activities, such as unauthorized port activity or file structures similar to known malware. In this sense, detection is only as good as the capability of the cybersecurity researcher. All three approaches are often used together in some sort of capacity to account for each's respective weakness, but it can be a slow and cumbersome process to detection, identification, and elimination. 

This current threat detection and identification process cannot be replaced, but can certainly be augmented by machine learning approaches, where the fingerprints of malware binaries can be picked out automatically through transformation to binary and images. We expect many downsides, especially in the detection of false-positives and the false detection of normal system files.


## Methods:
Using python and keras as the path to the tensorflow library, we seek to convert a library of virus binaries from thezoo and other malware sources to feed into a Convolutional Neural Network model to predict the the malicious nature of a given target file. The files can be of any type, as we assume that malicious actors can always hide malicious code inside innocuous files and not always the main PE.

A further extension of this project will also include computer vision analysis using the OpenCV-Python library to feature extract from the binary images.


## Executive Summary:
Initially, we wanted to look at the structure and do some machine learning analysis of the basic structures of a PE file. A slew of information is available in the header itself. However, this approach was met with two major hurdles - lack of domain knowledge and sparsity of data. In the first case, the field of cybersecurity uses many tools and actual human analyses on malware to understand its makeup and vector of attack. This is a very technically heavy field and out of the scope of this project. After viewing the sheer amount of tools that cybersecurity researchers use to decompose malwares, we decided that was outside the scope of this project. Furthermore, the sparsity of data was a major problem. Not all malware is a packaged neatly inside a portable executable. Scripts tend to be small, compact, and can be tagged onto existing programs as an attack vector. As such, if we limited our search and analysis to PEs, we may have encountered a sparsity in the data that we could not account for. Because we were comparing the data to other files on a computer system, we wanted to assume that from a high-overview, the attack vector could be ANY file. This makes our approach as generalizable as possible.

Most of the LIVE malware samples were taken from theZoo, a github repository with several hundred samples of infected malware, freely available to researchers. They are compressed as zips to make sure they are benign, but opening any file risks infection. In our case, because of time constraints, we were not able to host a VM for our static testing and model building, but we HIGHLY ADVISE future counterparts to not take such risks, especially on systems containing sensitive data.

From thezoo, we grabbed the entire set of malwares and wrote scripts inside our Jupyter notebook to unzip and prep the files for binarization into an image. A few files failed to open on our Mac OS environment, but this was only 1-2 files out of hundreds. We bibarized those files with basic numpy arrays for faster processing and to feed appropriately into our baseline sequential/cnn models. At this point, they could be featurized, or binarized to a smaller, digestable, more easily computed chunk for our neural network. This model was fitted using a variety of ReLu, LeakyRelu, and with adam optimization and accuracy as a measurement.


## Conclusions and Recommendations:
The sequential and CNN models performed no better than a baseline model. At nearly 75% malware to safeware accuracy ratio, it could not do better than random chance to label the data. This could be due to several large factors.

First and foremost, the lack of in-depth domain knowledge and the inability to obtain this knowledge in the time available. The dataset may also have been suboptimal for modeling. We were feeding every file unzipped from the live malwares without actually understanding if all those files were necessarily part of the primary infection or ancillary. In order to be generalizable, we took a shortcut, and this shortcut is a good place to improve moving forward.

There is much more room for improvement and in dataset setup. The approach has been taken on my many cyber security researchers in the last few months and a literature review may be requried to further understand the limitations of our approach.

Because we did not yet cover or incorporate feature extraction of the binary images into our analyses, this may be a further vector to increase performance or add to the viability of a CNN or simpler model.


## Sources

https://github.com/ytisf/theZoo

https://www.geeksonsite.com/computer-security/what-does-virus-scan-do-how-antivirus-software-works/

https://dzone.com/articles/building-a-slackbot-to-answer-analytics-questions

https://vizsec.org/files/2011/Nataraj.pdf

https://www.blackhat.com/presentations/bh-dc-07/Kendall_McMillan/Presentation/bh-dc-07-Kendall_McMillan.pdf

https://arxiv.org/pdf/1508.03096.pdf

https://www.camlis.org/2017/jeffreyjohns

https://devblogs.nvidia.com/malware-detection-neural-networks/







